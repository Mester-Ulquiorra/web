---
import { getAPIRoute } from "../../scripts/functions";
import { getUserData } from "../../scripts/userData";
import UserProfile from "../user-profile/UserProfile.astro";

const token = Astro.cookies.get("token").value;
const userData = token ? await getUserData(token) : null;

const wsRoute = getAPIRoute("ws");

interface Props {
  title: string;
}

const { title } = Astro.props;
---

<header data-wsroute={wsRoute} data-token={token}>
  <h1>{title}</h1>
  {
    userData && (
      <UserProfile
        userId={userData.userId}
        avatar={userData.avatar}
        userTag={userData.userTag}
      />
    )
  }
</header>

<style>
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background-color: var(--bg);
    border-bottom: var(--border);
  }

  @media (max-width: 768px) {
    h1 {
      display: none;
    }
  }
</style>

<script>
  import { $toastText } from "../../scripts/stores";
  import type { Alert } from "../../scripts/types";

  // setup the websocket responsible for polling real-time data only when we're not already on the alerts page
  if (location.pathname !== "/alerts") {
    // get the nav element
    const header = document.querySelector("header") as HTMLElement;
    const wsRoute = header.dataset.wsroute;
    const token = header.dataset.token;

    if(wsRoute && token) {
      const wsURL = new URL(wsRoute);
      wsURL.searchParams.append("token", token);
      const ws = new WebSocket(wsURL);
      ws.onmessage = (msg: MessageEvent<string>) => {
        if(msg.data === "ping" || msg.data.startsWith("welcome")) return;

        const message = JSON.parse(msg.data) as Alert;

        // TODO: do something more productive with it
        $toastText.set(message.data.reason);
      }
    }

  }
</script>
